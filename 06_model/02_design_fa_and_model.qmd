---
title: "[SIVOCS] Factor Analyis and Model Design"
author: ""
date: "5/22/2021"
format: 
  html:
    fig-width: 8
    fig-height: 4
    code-fold: true
---

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false

library(psych)
library(plotly)
library(lavaan)
library(tidyverse)
library(tidyr)

setwd("../../utku_SIVOCS/")
source("./02_analysis/02_static_responses.R")
source("./02_analysis/99_question_groups.R")
# Load the feature importances from python script
feature_list <- read.csv("./02_analysis/PFA_feature_importance.csv")

```

1.  Previously removed variables

```{r}
features_to_rm <- tail(feature_list$X0, 40)
# Qualitatively select the worse performing features
features_to_rm <- features_to_rm[c(22,26,29:40)]
features_to_rm <- c(features_to_rm, 
                    "dissChannels.trad.",
                    "dissChannels.socmed.",
                    "dissChannels.consult.",
                    "dissChannels.events.", 
                    "dissChannels.public.",
                    "concepts.data.",
                    "concepts.code.",
                    "concepts.infra.",
                    "contribToSI.rate.",
                    "groupsInvolved.res.",
                    "natureOfInvolvement.res.",
                    "contribToSI.rate.",
                    "concepts2"
                    )

# remove the weak features
df_red <- feat_df.num_o[, !(colnames(feat_df.num_o ) %in% features_to_rm)]
```

2.  We got a number of variables which actually measures the researchers, remove those.

-   Remove the variables from the previous 1. factor
-   Remove bussiness variables -\> useless
-   Remove scalability (measuring something else)

```{r}
## SI Familiarity Factor
factor_1 <- c("familiarWithSI.response.", "transdisciplinaryExp.rate.")
df_red <- df_red %>%
  select(-all_of(factor_1))

## MISC:business
factor_busi <- c("groupsInvolved.busi.", "impactTargetGroup.busi.", "kindOfChange.busi.")
df_red <- df_red %>%
  select(-all_of(factor_busi))


## MISC:scalability
factor_scale <- c("scalabilityRating.up.", "scalabilityRating.out.", "scalabilityRating.deep.")
df_red <- df_red %>%
  select(-all_of(factor_scale))

colnames(df_red)
```

-   Generate a df without the variables including another dimension of observation (researchers instead of projects) to run the FA on

```{r}
df_model <- feat_df.num_o %>%
  select(-all_of(c(factor_1, "contribToSI.rate.")))

colnames(df_model)
```

### Scree Plot

Determine Number of Factors to Extract

```{r }
library(nFactors)
ev <- eigen(cor(df_red)) # get eigenvalues

ap <- parallel(subject=nrow(df_red),var=ncol(df_red),
               rep=1000,cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS)  # 9 Factors

```

The optimal number of factors is 7

## Exploratory Factor Analysis

```{r}
# --- FA explanatory
# Maximum Likelihood Factor Analysis
# entering raw data and extracting 8 factors, 
# with varimax rotation 
fit <- factanal(df_red, 7, rotation="varimax")
print(fit, digits=2, cutoff=.3, sort=TRUE)

```

```{r}
model_theory <-"
  ## intention_agency
  ia_human_condition =~ motivation.welfare.+benefitForNonAcademy+impulseForNonAcad.soc.+targetGroupsGoals.improve.+impulseForNonAcad.health.+impulseForNonAcad.ecol.+kindOfChange.pub.+kindOfChange.socgr.+kindOfChange.welfare.+kindOfChange.civsoc.
  
  ia_non_academic =~ impulseForNonAcad.econ.+impulseForNonAcad.tech.
  
  ## transdisciplinary_apects
  transdisciplinary_social =~ groupsInvolved.citiz.+groupsInvolved.civsoc.+groupsInvolved.welfare.+natureOfInvolvement.citiz.+natureOfInvolvement.civsoc.+natureOfInvolvement.welfare.+targetGroupsGoals.socneeds.+targetGroupsGoals.socgroups.+targetGroupsGoals.empower.+targetGroupsGoals.diversity.
  outcome =~ impactTargetGroup.pub.+impactTargetGroup.socgr.+impactTargetGroup.welfare.+impactTargetGroup.civsoc.+Impactstatements.capab.+Impactstatements.emanc.+Impactstatements.understanding.+Impactstatements.mitig.+Impactstatements.unknown.+Impactstatements.unaddressed.
  
  ## MISC:policy
  policy =~ groupsInvolved.policy.+impactTargetGroup.policy.+kindOfChange.policy.+natureOfInvolvement.policy.+groupsInvolved.policy.+adoptByPolicyHow.SQ001."

```

```{r}
model_theory2 <-"
  # SOLUTION ORIENTATION
  ia_human_condition =~ 
  motivation.welfare. + 
  benefitForNonAcademy + 
  impulseForNonAcad.soc. + 
  targetGroupsGoals.improve. 
  
  ia_nonacad_impulse =~ 
  impulseForNonAcad.econ. + 
  impulseForNonAcad.tech. +
  impulseForNonAcad.health. + 
  impulseForNonAcad.ecol. 
  
  
  #  ACTORS & NETWORKS
  transdisciplinary_involvement =~ 
  groupsInvolved.citiz. + 
  groupsInvolved.civsoc. + 
  groupsInvolved.welfare. + 
  natureOfInvolvement.citiz. + 
  natureOfInvolvement.civsoc. + 
  natureOfInvolvement.welfare.
  
  
  transdisciplinary_goals =~ 
  targetGroupsGoals.socneeds. + 
  targetGroupsGoals.socgroups. + 
  targetGroupsGoals.empower. + 
  targetGroupsGoals.diversity.
  
  # NOVELTY 
  innovativeness =~
  kindOfChange.pub. + 
  kindOfChange.socgr. + 
  kindOfChange.welfare. + 
  kindOfChange.civsoc.
  
  
  # OUTCOME
  outcomes =~ 
  impactTargetGroup.pub. + 
  impactTargetGroup.socgr. + 
  impactTargetGroup.welfare. + 
  impactTargetGroup.civsoc. + 
  Impactstatements.capab. + 
  Impactstatements.emanc. + 
  Impactstatements.understanding. + 
  Impactstatements.mitig. + 
  Impactstatements.unknown. + 
  Impactstatements.unaddressed.
  
  # MISC:policy
  policy =~ groupsInvolved.policy.+impactTargetGroup.policy.+kindOfChange.policy.+natureOfInvolvement.policy.+groupsInvolved.policy.+adoptByPolicyHow.SQ001."

```

```{r}
model_theory3 <-"
  # SOLUTION ORIENTATION
  ia_human_condition =~ 
  motivation.welfare. + 
  benefitForNonAcademy + 
  impulseForNonAcad.soc. + 
  targetGroupsGoals.improve. 
  
  ia_nonacad_impulse =~ 
  impulseForNonAcad.econ. + 
  impulseForNonAcad.tech. +
  impulseForNonAcad.health. + 
  impulseForNonAcad.ecol. 
  
  
  #  ACTORS & NETWORKS
  transdisciplinary_involvement =~ 
  groupsInvolved.citiz. + 
  groupsInvolved.civsoc. + 
  groupsInvolved.welfare. + 
  groupsInvolved.policy. +
  natureOfInvolvement.citiz. + 
  natureOfInvolvement.civsoc. + 
  natureOfInvolvement.welfare. +
  natureOfInvolvement.policy.
  
  
  transdisciplinary_goals =~ 
  targetGroupsGoals.socneeds. + 
  targetGroupsGoals.socgroups. + 
  targetGroupsGoals.empower. + 
  targetGroupsGoals.diversity.
  
  # NOVELTY 
  innovativeness =~
  kindOfChange.pub. + 
  kindOfChange.socgr. + 
  kindOfChange.welfare. + 
  kindOfChange.civsoc. +
  kindOfChange.policy.
  
  
  # OUTCOME
  outcome =~ 
  impactTargetGroup.pub. + 
  impactTargetGroup.socgr. + 
  impactTargetGroup.welfare. + 
  impactTargetGroup.civsoc. + 
  impactTargetGroup.policy. +
  Impactstatements.capab. + 
  Impactstatements.emanc. + 
  Impactstatements.understanding. + 
  Impactstatements.mitig. + 
  Impactstatements.unknown. + 
  Impactstatements.unaddressed. +
  adoptByPolicyHow.SQ001.
"
```

# FA: Model evaluation:

## Factor analysis: Model 1

```{r}
fit_theory <- cfa(model_theory, df_model)
summary(fit_theory, fit.measures = T, standardized = T)
```

```{r}
modificationindices(fit_theory) %>%
  arrange(-mi) %>%
  head(10)
```

## Factor analysis: Model 2

```{r}
fit_theory2 <- cfa(model_theory2, df_model)
# Scale using latent variable variance rather than the first factor loading
fit_theory2b <- cfa(model_theory2, df_model, std.lv = T)
summary(fit_theory2, fit.measures = T, standardized = T)
```

```{r}
modificationindices(fit_theory2) %>%
  arrange(-mi) %>%
  head(10)
```

## Factor analysis: Model 3

```{r}
fit_theory3 <- cfa(model_theory3, df_model)
summary(fit_theory3, fit.measures = T, standardized = T)
```

```{r}
modificationindices(fit_theory3) %>%
  arrange(-mi) %>%
  head(10)
```

## FA Model Comparison

```{r}
anova(
  fit_theory
  , fit_theory2
  , fit_theory2b
  , fit_theory3
  )
```

`fit_theory2` performs significantly better than the others

```{r}
parameterestimates(fit_theory2b)
```

```{r}
fitmeasures(fit_theory3)
```

## Fitting data into the FA model

```{r}
library(scales)
df_fitted <- data.frame(predict(fit_theory2b))
# -> Scale all the variables from 0 to 10
df_fitted <- df_fitted %>%
  sapply(rescale, c(0, 10)) %>%
  round(digits = 2) %>%
  as.data.frame()

# fit_theory2b
```

## Linear Regression: Concrete Outcome as DV

```{r}
plot(df_fitted)
```

Factors seem to be in linear relationships against each other

```{r}
lm_fitted <- lm(outcomes ~ 
     ia_human_condition + 
     ia_nonacad_impulse +
     transdisciplinary_involvement +
     transdisciplinary_goals +
     innovativeness +
     policy,
   df_fitted
     )
summary(lm_fitted)
```

Regression model fits relatively well:

-   Adjusted R-squared high, p-value extremely small
-   The dominant IDVs in the model are transdisciplinary goals, innovativeness and in general policy involvement. Trans. involvement has also a small p-value but only limited influence in the concrete outcomes.

## Create an SI-Index and test against it

```{r}
si_index <- rowMeans(df_fitted)
lm_index_fitted <- lm(si_index ~
     outcomes +
     ia_human_condition + 
     ia_nonacad_impulse +
     transdisciplinary_involvement +
     transdisciplinary_goals +
     innovativeness +
     policy,
   df_fitted
     )
summary(lm_index_fitted)
```

Testing against a self-induced index doesn't help much

# Modelling approaches

## Ordinal logistic regression

* Split dataframe into test and train


```{r}
# Split into 2 groups
inds <- sample(2, nrow(df_fitted), replace = T, prob = c(0.8, 0.2))
train <- df_fitted[inds == 1, ]
test <- df_fitted[inds == 2, ]

```

* Apply ordinal logistic regression or proportional odds logistic regression

```{r}
library(MASS)
colnames(df_fitted)
ord_log_model <- polr(
  as.factor(outcomes) ~ 
    ia_human_condition + 
    ia_nonacad_impulse +
    transdisciplinary_involvement +
    transdisciplinary_goals +
    innovativeness +
    policy,
  train,
  Hess = T
  )
summary(ord_log_model)
```
* LRM p-values

```{r}
(ctable <- coef(summary(ord_log_model)))
```





























