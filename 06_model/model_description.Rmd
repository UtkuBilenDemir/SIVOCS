---
title: "Model_Description"
output:
  word_document: default
  pdf_document: default
date: '2022-05-11'
---

```{r setup, include=FALSE}
setwd("../../utku_SIVOCS/")
source("./02_analysis/02_static_responses.R")
source("./02_analysis/99_question_groups.R")
# Load the feature importances from python script
feature_list <- read.csv("./02_analysis/PFA_feature_importance.csv")

knitr::opts_chunk$set(echo = FALSE, 
                      message=FALSE, 
                      warning=FALSE
                      )
```

```{r include = FALSE}
library(psych)
library(plotly)
library(lavaan)
library(tidyverse)
library(tidyr)
```

# SI-Characteristics

The following were the initial SI-Characteristics decided through preliminary research and discussion rounds:

```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", fig.cap=c("your caption"), echo=FALSE}
knitr::include_graphics("../06_model/SIVOCS - SI characteristics.pdf")
```

# Variable Preprocessing

The elimination of the variables relied on 2 different type of considerations:

* Elimination by Principal Feature Analysis

* Explained Variance




## Principal Feature Analysis

```{r}
# TODO: Describe Principal Feature Analysis
```

After the 1000 iterations of PFA, the following are the frequency of each variable being in the "significant" variables list:

```{r fig.height=8}

#fig <- plot_ly(x = feature_list$X1, 
#               y = feature_list$X0, 
#               type = 'bar', 
#               orientation = 'h'
#               ) %>% 
#  layout(yaxis = list(categoryorder = "total ascending"))
#
#fig
feature_list$X0 <- factor(feature_list$X0, levels = rev(feature_list$X0))
ggplot(feature_list, aes(x = X1, y = X0))+
  geom_col( width = 0.7)
```

## Removed Features

Note: Some of the features have been kept despite being rated low importance by PFA

```{r}
# TODO: Explain each 
```


"dissChannels.platf."       "dissChannels.prof."       
"dissChannels.mono."        "concepts.review."         
"adoptByPolicyHow.SQ002."   "dissChannels.peer."       
 "dissChannels.policy."      "concepts.pub."            
"natureOfInvolvement.busi." "dissChannels.web."        
"concepts3"                 "dissChannels.conf."       
"adoptByPolicy.rate."       "adoptByPolicyHow.SQ003."  
"dissChannels.trad."        "dissChannels.socmed."     
"dissChannels.consult."     "dissChannels.events."     
"dissChannels.public."      "concepts.data."           
"concepts.code."            "concepts.infra."          
"contribToSI.rate."         "groupsInvolved.res."      
"natureOfInvolvement.res."  "contribToSI.rate."

```{r pressure, echo=FALSE}
features_to_rm <- tail(feature_list$X0, 40)
# Qualitatively select the worse performing features
features_to_rm <- features_to_rm[c(22,26,29:40)]
features_to_rm <- c(features_to_rm, 
                    "dissChannels.trad.",
                    "dissChannels.socmed.",
                    "dissChannels.consult.",
                    "dissChannels.events.", 
                    "dissChannels.public.",
                    "concepts.data.",
                    "concepts.code.",
                    "concepts.infra.",
                    "contribToSI.rate.",
                    "groupsInvolved.res.",
                    "natureOfInvolvement.res.",
                    "contribToSI.rate."
                    )

# remove the weak features
df_red <- feat_df.num_o[, !(colnames(feat_df.num_o ) %in% features_to_rm)]
```
# Model Approach Considerations

## Factor analysis

### Scree Plot
Determine Number of Factors to Extract

```{r }
library(nFactors)
ev <- eigen(cor(df_red)) # get eigenvalues

ap <- parallel(subject=nrow(df_red),var=ncol(df_red),
               rep=100,cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS)  # 9 Factors

```
The optimal number of factors is 8

## Exploratory Factor Analysis

```{r}
# --- FA explanatory
# Maximum Likelihood Factor Analysis
# entering raw data and extracting 8 factors, 
# with varimax rotation 
fit <- factanal(df_red, 8, rotation="varimax")
print(fit, digits=2, cutoff=.3, sort=TRUE)

```

```{r fig.height=8}
fa.diagram(fit$loadings,
           size = 24,
           digits = 2, 
           rsize = 0.1)
```

```{r}
# TODO: Table representation
```

### Confirmatory Factory Analysis (Theory driven model)

```{r}

# TODO: Table display
model_theory <-"
  ## SI Familiarity
  fam =~ familiarWithSI.response.+transdisciplinaryExp.rate.
  
  ## intention_agency
  ia_human_condition =~ motivation.welfare.+benefitForNonAcademy+impulseForNonAcad.soc.+targetGroupsGoals.improve.+impulseForNonAcad.health.+impulseForNonAcad.ecol.
  
  ia_non_academic =~ impulseForNonAcad.econ.+impulseForNonAcad.tech.
  
  ## transdisciplinary_apects
  transdisciplinary_social =~ groupsInvolved.citiz.+groupsInvolved.civsoc.+groupsInvolved.welfare.+natureOfInvolvement.citiz.+natureOfInvolvement.civsoc.+natureOfInvolvement.welfare.+targetGroupsGoals.socneeds.+targetGroupsGoals.socgroups.+targetGroupsGoals.empower.+targetGroupsGoals.diversity.
  
  ## outcome
  outcome_public =~ impactTargetGroup.pub.+impactTargetGroup.socgr.+impactTargetGroup.welfare.+impactTargetGroup.civsoc.+kindOfChange.pub.+kindOfChange.socgr.+kindOfChange.welfare.+kindOfChange.civsoc.
  
  outcome_statement =~ Impactstatements.capab.+Impactstatements.emanc.+Impactstatements.understanding.+Impactstatements.mitig.+Impactstatements.unknown.+Impactstatements.unaddressed.
  
  ## MISC:scalability
  scale =~ scalabilityRating.up.+scalabilityRating.out.+scalabilityRating.deep.
  
  ## MISC:policy
  policy =~ groupsInvolved.policy.+impactTargetGroup.policy.+kindOfChange.policy.+natureOfInvolvement.policy.+groupsInvolved.policy.+adoptByPolicyHow.SQ001. 
  
  ## MISC:business
  busi =~ groupsInvolved.busi.+impactTargetGroup.busi.+kindOfChange.busi.
"

```

```{r}

fit_theory <- cfa(model_theory, df_red)
summary(fit_theory, fit.measures = T, standardized = T)

```

**Observations:**

* Goodness of fit, Chi-Squared p value is very small (0.000)
* CFI and TFI are questionable but not too low (~0.65), normailly expected ~0.9
* RMSEA is surprisingly high (0.092) and stat. significant (0.000), the values I've seen so far were always ~0.05 and rarely significant
* SRMR is high (0.086), indication of a good fitting model.
* P values of the loadings are almost too good other than a couple of variables (to be addressed)
* Covariances are to be discussed
* Variance estimates are to be discussed (e.g. ia_non:academic has very low variance -0.0005, what does it indicate)



# Model Output

## Correlation between the *self assessment SI-Rate* and the prediction

```{r, echo=FALSE, fig.width=10, fig.height=4, dev='svg', fig.retina=2, fig.align='center'}

DF.refined <- data.frame(predict(fit_theory))

SI.fit_scale <- scales::rescale(apply(DF.refined, mean, MARGIN = 1), to = c(0, 10))
SI_rate.self <- feat_df$contribToSI.rate.

# Create a df for fitted and self assessed SI-Rates
si_df <- data.frame(
  fitted = SI.fit_scale,
  self   = SI_rate.self
  ) 
# Turn self assesment into an ordinal with 3 levels
si_df.likert <- si_df
si_df.likert$self <- likert_recode(feat_df.num$contribToSI.rate.)

col_seq <- c("#f4a582",
"#92c5de",
"#2166ac")


SI_corr_vis <- si_df.likert %>% 
  filter(!is.na(self)) %>%
  gather(key="fitted", value="self") %>%
  ggplot(aes(x=fitted, y=self, fill=self),  show.legend = FALSE) +
    geom_boxplot() +
  ylab(" ") +
  theme_light() +
  theme(axis.text.y=element_blank()) +
  scale_fill_discrete(name = "SI Rate (self-assessment)") + 
  xlab("Theory driven SI-Index") + 
  scale_fill_manual(values=col_seq, name="SI Rate (self-assessment)") + 
guides(fill=guide_legend(reverse = TRUE))

SI_corr_vis

```

```{r}
# TODO: Explain

comp_cor <- cor(si_df$fitted, si_df$self, use = "pairwise.complete.obs", method = "spearman")



# Change the confidence interval fill color
ggplot(si_df, aes(y=self, x=fitted)) + 
  geom_point(shape=18, color="blue")+
  geom_smooth(method=lm,  linetype="dashed",
             color="darkred", fill="blue") + 
  geom_text( aes( x=0, y=9, label=paste0("Cor: " , round(comp_cor, 2))),                 , 
           color="black", 
           size=4, fontface="bold" )
```



# How to Create a (Re-)Appliable Formulation